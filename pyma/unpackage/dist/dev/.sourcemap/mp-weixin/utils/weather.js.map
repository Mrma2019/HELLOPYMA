{"version":3,"file":"weather.js","sources":["utils/weather.js"],"sourcesContent":["import config from \"@/config/config\"\r\nimport weatherStore from '@/store/weatherStore.js'\r\n\r\n/**\r\n * 封装 uni.request 返回 Promise\r\n */\r\nfunction request(options) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tuni.request({\r\n\t\t\t...options,\r\n\t\t\tsuccess: resolve,\r\n\t\t\tfail: reject\r\n\t\t})\r\n\t})\r\n}\r\n\r\n/**\r\n * 封装 uni.getLocation 返回 Promise\r\n */\r\nfunction getLocation() {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tuni.getLocation({\r\n\t\t\ttype: 'gcj02',\r\n\t\t\tsuccess: resolve,\r\n\t\t\tfail: reject\r\n\t\t})\r\n\t})\r\n}\r\n\r\n/**\r\n * 获取实时天气\r\n */\r\nexport async function getWeatherByAdcode(code) {\r\n\tconst res = await request({\r\n\t\turl: config.weatherUrl,\r\n\t\tdata: {\r\n\t\t\tkey: config.apiKey,\r\n\t\t\tlocation: code\r\n\t\t}\r\n\t})\r\n\r\n\tif (res.data.code !== \"200\") throw new Error('获取天气数据失败')\r\n\r\n\tconst weatherInfo = res.data.now\r\n\tweatherStore.data = {\r\n\t\t...weatherInfo,\r\n\t\t...weatherStore.data\r\n\t}\r\n\treturn weatherInfo\r\n}\r\n\r\n/**\r\n * 获取格点天气\r\n */\r\nexport async function getGridWeatherByAdcode(lon, lat) {\r\n\tconst res = await request({\r\n\t\turl: config.gridWeatherUrl,\r\n\t\tdata: {\r\n\t\t\tkey: config.apiKey,\r\n\t\t\tlocation: `${lon},${lat}`\r\n\t\t}\r\n\t})\r\n\r\n\tif (res.data.code !== \"200\") throw new Error('获取格点天气失败')\r\n\r\n\tconst gridInfo = res.data\r\n\tweatherStore.girdInfo = gridInfo\r\n\treturn gridInfo\r\n}\r\n\r\n/**\r\n * 获取天气指数\r\n */\r\nexport async function getIndices(lon, lat) {\r\n\tconst res = await request({\r\n\t\turl: config.indicesUrl,\r\n\t\tdata: {\r\n\t\t\tkey: config.apiKey,\r\n\t\t\ttype: 1,\r\n\t\t\tlocation: `${lon},${lat}`\r\n\t\t}\r\n\t})\r\n\r\n\tif (res.data.code !== \"200\") throw new Error('获取天气指数失败')\r\n\r\n\tconst indices = res.data\r\n\tweatherStore.indices = indices\r\n\treturn indices\r\n}\r\n\r\n/**\r\n * 获取天气数据（统一封装）\r\n * 返回对象 { weather, gridWeather, indices }\r\n */\r\nexport default async function getWeather() {\r\n\ttry {\r\n\t\tconst {\r\n\t\t\tlatitude,\r\n\t\t\tlongitude\r\n\t\t} = await getLocation()\r\n\r\n\t\t// console.log(latitude, longitude);\r\n\r\n\t\t// 获取 adcode\r\n\t\tconst adRes = await request({\r\n\t\t\turl: config.adCodeUrl,\r\n\t\t\tdata: {\r\n\t\t\t\tkey: config.apiKey,\r\n\t\t\t\tlocation: `${longitude},${latitude}`\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\t// console.log(adRes);\r\n\r\n\t\tif (adRes.data.code !== \"200\") throw new Error('获取位置信息失败')\r\n\r\n\t\tconst location = adRes.data.location[0]\r\n\t\tconst adcode = location.id\r\n\t\tweatherStore.data.location = location\r\n\r\n\t\t// 并行请求天气数据\r\n\t\tconst [weather, gridWeather, indices] = await Promise.all([\r\n\t\t\tgetWeatherByAdcode(adcode),\r\n\t\t\tgetGridWeatherByAdcode(longitude, latitude),\r\n\t\t\tgetIndices(longitude, latitude)\r\n\t\t])\n\t\t//记载完成\r\n\t\tweatherStore.loading = false;\n\t\t\r\n\t\treturn {\r\n\t\t\tweather,\r\n\t\t\tgridWeather,\r\n\t\t\tindices\r\n\t\t}\r\n\t} catch (err) {\r\n\t\tconsole.error(err)\r\n\t\tthrow err\r\n\t}\r\n}"],"names":["uni","config","weatherStore"],"mappings":";;;;AAMA,SAAS,QAAQ,SAAS;AACzB,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACvCA,kBAAAA,MAAI,QAAQ;AAAA,MACX,GAAG;AAAA,MACH,SAAS;AAAA,MACT,MAAM;AAAA,IACT,CAAG;AAAA,EACH,CAAE;AACF;AAKA,SAAS,cAAc;AACtB,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACvCA,kBAAAA,MAAI,YAAY;AAAA,MACf,MAAM;AAAA,MACN,SAAS;AAAA,MACT,MAAM;AAAA,IACT,CAAG;AAAA,EACH,CAAE;AACF;AAKO,eAAe,mBAAmB,MAAM;AAC9C,QAAM,MAAM,MAAM,QAAQ;AAAA,IACzB,KAAKC,cAAM,OAAC;AAAA,IACZ,MAAM;AAAA,MACL,KAAKA,cAAM,OAAC;AAAA,MACZ,UAAU;AAAA,IACV;AAAA,EACH,CAAE;AAED,MAAI,IAAI,KAAK,SAAS;AAAO,UAAM,IAAI,MAAM,UAAU;AAEvD,QAAM,cAAc,IAAI,KAAK;AAC7BC,qBAAAA,aAAa,OAAO;AAAA,IACnB,GAAG;AAAA,IACH,GAAGA,mBAAY,aAAC;AAAA,EAChB;AACD,SAAO;AACR;AAKO,eAAe,uBAAuB,KAAK,KAAK;AACtD,QAAM,MAAM,MAAM,QAAQ;AAAA,IACzB,KAAKD,cAAM,OAAC;AAAA,IACZ,MAAM;AAAA,MACL,KAAKA,cAAM,OAAC;AAAA,MACZ,UAAU,GAAG,GAAG,IAAI,GAAG;AAAA,IACvB;AAAA,EACH,CAAE;AAED,MAAI,IAAI,KAAK,SAAS;AAAO,UAAM,IAAI,MAAM,UAAU;AAEvD,QAAM,WAAW,IAAI;AACrBC,qBAAY,aAAC,WAAW;AACxB,SAAO;AACR;AAKO,eAAe,WAAW,KAAK,KAAK;AAC1C,QAAM,MAAM,MAAM,QAAQ;AAAA,IACzB,KAAKD,cAAM,OAAC;AAAA,IACZ,MAAM;AAAA,MACL,KAAKA,cAAM,OAAC;AAAA,MACZ,MAAM;AAAA,MACN,UAAU,GAAG,GAAG,IAAI,GAAG;AAAA,IACvB;AAAA,EACH,CAAE;AAED,MAAI,IAAI,KAAK,SAAS;AAAO,UAAM,IAAI,MAAM,UAAU;AAEvD,QAAM,UAAU,IAAI;AACpBC,qBAAY,aAAC,UAAU;AACvB,SAAO;AACR;AAMe,eAAe,aAAa;AAC1C,MAAI;AACH,UAAM;AAAA,MACL;AAAA,MACA;AAAA,IACA,IAAG,MAAM,YAAa;AAKvB,UAAM,QAAQ,MAAM,QAAQ;AAAA,MAC3B,KAAKD,cAAM,OAAC;AAAA,MACZ,MAAM;AAAA,QACL,KAAKA,cAAM,OAAC;AAAA,QACZ,UAAU,GAAG,SAAS,IAAI,QAAQ;AAAA,MAClC;AAAA,IACJ,CAAG;AAID,QAAI,MAAM,KAAK,SAAS;AAAO,YAAM,IAAI,MAAM,UAAU;AAEzD,UAAM,WAAW,MAAM,KAAK,SAAS,CAAC;AACtC,UAAM,SAAS,SAAS;AACxBC,oCAAa,KAAK,WAAW;AAG7B,UAAM,CAAC,SAAS,aAAa,OAAO,IAAI,MAAM,QAAQ,IAAI;AAAA,MACzD,mBAAmB,MAAM;AAAA,MACzB,uBAAuB,WAAW,QAAQ;AAAA,MAC1C,WAAW,WAAW,QAAQ;AAAA,IACjC,CAAG;AAEDA,uBAAY,aAAC,UAAU;AAEvB,WAAO;AAAA,MACN;AAAA,MACA;AAAA,MACA;AAAA,IACA;AAAA,EACD,SAAQ,KAAK;AACbF,kBAAAA,MAAc,MAAA,SAAA,2BAAA,GAAG;AACjB,UAAM;AAAA,EACN;AACF;;"}